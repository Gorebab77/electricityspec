<head><title></title><meta charset="utf-8"><link rel="stylesheet" href="./styles.css"></head><body class="light-theme blue_sky" style="padding: 20px;"><div class="shine-editor"><h2>[소스설명] - lp.cpp</h2><div><br></div><div><b><span class="shine-text-purple">✅전체 소스들</span></b></div><ul><li><b><span class="shine-text-purple">이 소스코드는 스마트 미터 펌웨어에서 Load Profile(LP), 평균 전압/ 전류, 백터(위상 사분면), 시간정보, 요금제( Tariff), 히스토리 로그 등을 저장/처리/복구 하는 핵심 기능들을 담고 있음.</span></b></li></ul><div><b><span class="shine-text-purple">✅시간 관련 함수</span></b><br></div><div><b><span class="shine-text-purple">@meter_set_time()</span></b></div><ul><li><pre spellcheck="false">void meter_set_time(time_t mTime, struct tm *t)</pre></li><li>시스템 시간( meter_time_t) 을 설정하며, 구조체 형태의 meter_time에도 동일한 값을 저자함.</li><li><br></li></ul><div><b><span class="shine-text-purple">@meter_get_date_time() 함수</span></b></div><ul><li><pre spellcheck="false">date_time_type *meter_get_date_time(void)</pre></li><li>meter_time 을 임시변수 meter_time2 로 복사 후 반환 타이밍 이슈방지를 위해 clock_lock() 으로 동기화 보호</li><li><br></li></ul><div><b><span class="shine-text-purple">@compress_time() 함수 , expand_time() 함수</span></b></div><ul><li><pre spellcheck="false">void compress_time(...) / void expand_time(...)</pre></li><li>4바이트로 압축하거나 구조체로 복원, LP 기록 시 시간 공간 절약을 위해 사용됩니다.</li></ul><div><br></div><div><b><span class="shine-text-purple">✅LP 관련 함수 (Load Profile 저장 / 계산)</span></b><br></div><div><b><span class="shine-text-purple">@add_up_lp_realtime()</span></b></div><ul><li><pre spellcheck="false">void add_up_lp_realtime(...)</pre></li><li>현재 측정 데이터를 기반으로 실시간 LP값 누적 및 벡터 분류별로 저장함(수전/송전,유효/무효/피상 전력)</li><li>VECTOR_Qx 사분면을 기준으로 데이터를&nbsp; eChRcvAct , eChDeliLagReact, eChRvApp 등에 저장</li><li><br></li></ul><div><b><span class="shine-text-purple">@get_vector() 함수</span></b></div><ul><li><pre spellcheck="false">vector_value get_vector(float angle)</pre></li><li>전압 위상각을 기반으로 벡터 사분면 (VECTOR_Q1~Q4) 을 반환합니다.</li><li><br></li></ul><div><b><span class="shine-text-purple">@update_lp_realtime()</span></b></div><ul><li><pre spellcheck="false">vector_value update_lp_realtime(tMeterCtl *pMeter)</pre></li><li>실시간 LP 누적 함수인 add_up_lp_realtime() 을 호출하고 전체 벡터 분류 및 평균전압/전류도 함께 수행</li></ul><div><br></div><div><b><span class="shine-text-purple">@add_avg_vol_cur()</span></b></div><ul><li><pre spellcheck="false">void add_avg_vol_cur(tMeterCtl *pMeter)</pre></li><li>전압, 전류,위상각도, THD(전압 고조파)등의 평균값을 누적 계산.</li></ul><div><br></div><div><b><span class="shine-text-purple">✅LP 저장 함수&nbsp;</span></b><br></div><div><b><span class="shine-text-purple">@save_lp_realtime_record()</span></b></div><ul><li><pre spellcheck="false">int save_lp_realtime_record(...)</pre></li><li>실시간 LP를 m_lp_realtime_save_record[] 에 압축 저장.</li><li>저장 인덱스 및 사용 개수 업데이트</li><li><br></li></ul><div><b><span class="shine-text-purple">@save_lp_record() 함수</span></b></div><ul><li><pre spellcheck="false">int save_lp_record(...)</pre></li><li>일반 LP 레코드를 영구 저장소에 기록 (EEPROM 등)</li><li>이벤트 정보도 함께 저장되며, write index 및 total count관리</li><li><br></li></ul><div><b><span class="shine-text-purple">✅LP 읽기 / 복구 함수</span></b><br></div><div><b><span class="shine-text-purple">@meter_read_last_lp()</span></b></div><ul><li><pre spellcheck="false">int meter_read_last_lp(...)</pre></li><li>가장 최근에 저장된 LP를 읽고 복사.</li><li><br></li></ul><div><b><span class="shine-text-purple">@meter_read_current_lp() 함수</span></b></div><ul><li><pre spellcheck="false">int meter_read_current_lp(...)</pre></li><li>현재 push되어 있는 LP 데이터를 임시 버퍼로 복사</li></ul><div><br></div><div><b><span class="shine-text-purple">✅수전/송전 모드에 따른 LP 계산 함수</span></b><br></div><div><b><span class="shine-text-purple">@cal_rcv_mode(...) /&nbsp;cal_deli_rcv_mode(...)</span></b></div><ul><li><pre spellcheck="false">int cal_rcv_mode(...) / cal_deli_rcv_mode(...)</pre></li><li>현재 설정된 KEPCO 수전/송전 모드에 따라 LP 채널이 데이터를 누적</li><li><br></li></ul><div><b><span class="shine-text-purple">@cal_rcv_1phase_mode() /&nbsp;cal_rcv_composite_mode()</span></b></div><ul><li><pre spellcheck="false">int cal_rcv_1phase_mode(...) / cal_rcv_composite_mode(...)</pre></li><li>단상 기준으로 벡터에 따라 유효 / 무효 / 피상 전력을 수전/송전 각각의 채널에 누적.</li></ul><div><br></div><div><b><span class="shine-text-purple">✅평균 전압 / 전류 저장 함수</span></b><br></div><div><b><span class="shine-text-purple">@save_avg_vol_cur()</span></b></div><ul><li><pre spellcheck="false">int save_avg_vol_cur(...)</pre></li><li>평균 전압 / 전류 데이터를 EEPROM에 저장</li><li>백업을 위해 임시 배열에도 저장 가능.</li><li><br></li></ul><div><b><span class="shine-text-purple">@save_avg_vol_cur_temp() 함수</span></b></div><ul><li><pre spellcheck="false">int save_avg_vol_cur_temp(...)</pre></li><li>통신 실패 또는 비정상 종료 시를 대비한 임시 저장 함수.</li><li><br></li></ul><div><b><span class="shine-text-purple">✅벡터 / 전력 값 추출 함수</span></b></div><div><b><span class="shine-text-purple">@get_ch_act() /&nbsp;get_ch_React() /&nbsp;get_ch_apperent()</span></b></div><ul><li><pre spellcheck="false">int get_ch_act(...) / get_ch_React(...) / get_ch_apperent(...)</pre></li><li>지정된 phase에서 유효 / 무효 / 피상 전력 값을 벡터 방향에 따라 반환.</li><li><br></li></ul><div><b><span class="shine-text-purple">✅최대 수요 전력, TOU (Time of Use) 요금 저장 /조회</span></b></div><div><b><span class="shine-text-purple">@save_tariff_power() /&nbsp;meter_read_month_mrd_data()&nbsp;</span></b></div><ul><li><pre spellcheck="false">int save_tariff_power(...) / meter_read_month_mrd_data(...)</pre></li><li>TOU 요금제별 전력 데이터를 저장/조회</li><li><br></li></ul><div><b><span class="shine-text-purple">@save_tariff_max_power()</span></b></div><ul><li><pre spellcheck="false">int save_tariff_max_power(...)</pre></li><li>최대 수요 전력 정보를 시간 / 구간 기준 으로 저장.</li><li><br></li></ul><div><b><span class="shine-text-purple">✅히스토리 로그 저장 함수</span></b></div><div><b><span class="shine-text-purple">@history_save()</span></b></div><ul><li><pre spellcheck="false">int history_save(...)</pre></li><li>이벤트 (전원 복구, 시간변경 등)를 프로파일에 저장</li><li><br></li></ul><div><b><span class="shine-text-purple">@history_security_save()</span></b></div><ul><li><pre spellcheck="false">int history_security_save(...)</pre></li><li>보안 이벤트 기록 저장</li><li><br></li></ul><div><b><span class="shine-text-purple">@history_loadlimit_save()</span></b></div><ul><li><pre spellcheck="false">int history_loadlimit_save(...)</pre></li><li>부하 제한이 걸렸을 때 기록 저장</li><li><br></li></ul><div><b><span class="shine-text-purple">✅기타 보조 함수</span></b></div><div><b><span class="shine-text-purple">@print_tou_power_capture() /&nbsp;get_channel_name()</span></b></div><ul><li><pre spellcheck="false">int print_tou_power_capture(...) / get_channel_name(...)</pre></li><li>TOU 요금제 데이터 디버깅 출력 / 채널 명칭 반환.</li><li><br></li></ul><div><b><span class="shine-text-purple">@smoothing_moving_average()&nbsp;</span></b></div><ul><li><pre spellcheck="false">int smoothing_moving_average(...)</pre></li><li>측정 값 평활화 (Smoothing)처리.&nbsp;</li><li>THD 같은 변동이 큰 값에 유용</li></ul><div><br></div><div><b><span class="shine-text-purple">✅흐름도 간략 요약</span></b><br></div><pre spellcheck="false">주기적으로 측정 시작<br> └─&gt; update_lp_realtime()           // 실시간 LP 계산<br>     ├─&gt; get_vector()               // 벡터 방향 결정<br>     ├─&gt; add_up_lp_realtime()       // 누적 및 채널 기록<br>     └─&gt; add_avg_vol_cur()         // 평균 전압/전류 계산<br><br>측정 주기 완료 시<br> └─&gt; update_lp_record()            // LP 누적 처리<br>     └─&gt; cal_rcv_mode() 등 호출    // 설정 모드 기반 누적<br> └─&gt; save_lp_record()             // EEPROM 기록<br> └─&gt; save_tariff_power()          // 요금제 누적 전력 저장<br> └─&gt; save_avg_vol_cur()           // 평균 값 저장<br><br>정기적으로<br> └─&gt; history_save(), save_tariff_max_power()</pre><div><br></div><div><img width="75%" src="Files/image.png"><br></div><div><img width="75%" src="Files/image%202.png"><br></div><div><img width="75%" src="Files/image%203.png"><br></div><div><img width="75%" src="Files/image%204.png"><br></div></div></body>